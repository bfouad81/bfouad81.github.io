<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cargo Acceptance & Receiving Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

<style>
:root{
  --red-main:#c62828;
  --red-soft:#f6eaea;
  --border-soft:#ddd;
}
*{box-sizing:border-box;}
body{margin:0;padding:0;background:#f2f2f2;font-family:Arial,sans-serif;color:#000;}
.form-container{
  max-width:1200px;
  margin:0 auto;
  padding:10px 15px;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  padding:15px 20px;
  background:#fff;
  border-bottom:4px solid var(--red-main);
}
.logo img{
  max-width:100%; max-height:70px; object-fit:contain;
}
.header-text{flex:1;text-align:right;}
.header-text h2{margin:0;color:var(--red-main);}
.header-text p{margin:5px 0 0;opacity:0.9;text-align:right;}
@media(max-width:900px){
  .header{flex-direction:column;align-items:center;text-align:center;}
  .header-text{text-align:center;margin-top:10px;}
}

/* Sections */
.section{padding:20px;border-bottom:1px solid var(--border-soft); page-break-inside:avoid;}
.section-title{
  display:block;
  width:100%;
  padding:10px 20px;
  font-weight:bold;
  color:#fff;
  background-color:var(--red-main);
  border-radius:12px;
  margin-bottom:15px;
  font-size:16px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.note{font-size:13px;color:#666;margin:10px 0;}

/* Grid */
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:15px;}
.col-1{grid-column:span 1}.col-2{grid-column:span 2}.col-3{grid-column:span 3}
.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}
.col-8{grid-column:span 8}.col-12{grid-column:span 12}

/* Fields */
label{font-size:13px;font-weight:bold;}
input,select,textarea{width:100%;padding:9px;margin-top:6px;border:1px solid var(--border-soft);border-radius:6px;transition:.2s}
textarea{resize:vertical}
input.filled,select.filled,textarea.filled{background:var(--red-soft);border-color:var(--red-main);}
.error-msg{color:#c62828;font-size:12px;margin-top:4px;display:none;}

/* Signature */
.signature-box{border:1px dashed var(--border-soft);border-radius:6px;height:160px;background:#fafafa;}
.clear-btn{margin-top:6px;padding:5px 10px;border:none;background:#eee;cursor:pointer;border-radius:4px;}
.clear-btn:hover{background:#ddd;}
.submit-btn{width:100%;padding:18px;border:none;background:var(--red-main);color:#fff;font-size:16px;cursor:pointer;border-radius:8px;transition:.3s;}
.submit-btn:hover:not(:disabled){background:#a01f1f;}
.submit-btn:disabled{opacity:0.6;cursor:not-allowed;}

/* Hide in PDF */
.hide-in-pdf{display:block;}
@media print{
  .hide-in-pdf{display:none !important;}
}

/* Responsive */
@media(max-width:900px){
  .col-1,.col-2,.col-3,.col-4,.col-5,.col-6,.col-8{grid-column:span 12 !important;}
}
</style>
</head>

<body>
<div class="form-container">

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <img src="https://raw.githubusercontent.com/bfouad81/logo/refs/heads/main/New%20Bitmap%20image.bmp" alt="Company Logo">
  </div>
  <div class="header-text">
    <h2>Cargo Acceptance & Receiving Form</h2>
  </div>
</div>

<!-- CUSTOMER -->
<div class="section">
<div class="section-title">Customer / Shipper</div>
<div class="row">
  <div class="col-4">
    <label>Name *</label>
    <input id="customerName" required>
    <span class="error-msg" id="error-customerName">This field is required</span>
  </div>
  <div class="col-4">
    <label>Phone *</label>
    <input id="customerPhone" required>
    <span class="error-msg" id="error-customerPhone">This field is required</span>
  </div>
  <div class="col-4">
    <label>Address *</label>
    <input id="customerAddress" required>
    <span class="error-msg" id="error-customerAddress">This field is required</span>
  </div>
  <div class="col-4"><label>Email</label><input id="customerEmail" type="email"></div>
</div>
</div>

<!-- CONSIGNEE -->
<div class="section">
<div class="section-title">Consignee / Receiver</div>
<div class="row">
  <div class="col-4">
    <label>Name *</label>
    <input id="consigneeName" required>
    <span class="error-msg" id="error-consigneeName">This field is required</span>
  </div>
  <div class="col-4">
    <label>Phone *</label>
    <input id="consigneePhone" required>
    <span class="error-msg" id="error-consigneePhone">This field is required</span>
  </div>
  <div class="col-4">
    <label>Address *</label>
    <input id="consigneeAddress" required>
    <span class="error-msg" id="error-consigneeAddress">This field is required</span>
  </div>
  <div class="col-4"><label>Email</label><input id="consigneeEmail" type="email"></div>
  <div class="col-4"><label>Company Name (if any)</label><input id="consigneeCompany"></div>
</div>
</div>

<!-- SHIPMENT -->
<div class="section">
<div class="section-title">Shipment Details</div>
<div class="row">
  <div class="col-6">
    <label>Mode of Transport *</label>
    <select id="transportMode" required>
      <option value="">Select</option><option>Land</option><option>Air</option><option>Sea</option>
    </select>
    <span class="error-msg" id="error-transportMode">This field is required</span>
  </div>
  <div class="col-6">
    <label>Shipment Type *</label>
    <select id="shipmentType" required>
      <option value="">Select</option><option>LTL</option><option>FTL</option><option>Courier</option><option>Other</option>
    </select>
    <span class="error-msg" id="error-shipmentType">This field is required</span>
  </div>
</div>
</div>

<!-- CARGO -->
<div class="section">
<div class="section-title">Cargo Description (As Declared by Shipper)</div>
<p class="note">All information below is as declared by the shipper. Actual weight & CBM may differ.</p>
<div class="row">
  <div class="col-6">
    <label>Description *</label>
    <input id="goodsDescription" required>
    <span class="error-msg" id="error-goodsDescription">This field is required</span>
  </div>
  <div class="col-3">
    <label>Packaging *</label>
    <select id="packagingType" required>
      <option value="">Select</option>
      <option>Box</option><option>Pallet</option><option>Wooden Crate</option><option>Drum</option><option>Bag</option>
    </select>
    <span class="error-msg" id="error-packagingType">This field is required</span>
  </div>
  <div class="col-1">
    <label>Pkgs *</label>
    <input id="packages" type="number" min="1" required>
    <span class="error-msg" id="error-packages">Required</span>
  </div>
  <div class="col-1">
    <label>KG *</label>
    <input id="declaredWeight" type="number" min="0.1" step="0.1" required>
    <span class="error-msg" id="error-declaredWeight">Required</span>
  </div>
  <div class="col-1">
    <label>CBM *</label>
    <input id="cbm" type="number" min="0.01" step="0.01" required>
    <span class="error-msg" id="error-cbm">Required</span>
  </div>
</div>
</div>

<!-- DOCUMENTS -->
<div class="section hide-in-pdf">
  <div class="section-title">Documents Upload (Optional)</div>

  <div class="row">
    <div class="col-4">
      <label>Invoice</label>
      <input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>

    <div class="col-4">
      <label>Packing List</label>
      <input type="file" id="packingListFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>

    <div class="col-4">
      <label>CMR / Waybill</label>
      <input type="file" id="cmrFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>

    <div class="col-4">
      <label>Certificate of Origin</label>
      <input type="file" id="originFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>

    <div class="col-4">
      <label>MSDS</label>
      <input type="file" id="msdsFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>

    <div class="col-4">
      <label>Other Document</label>
      <input type="file" id="otherFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>
  </div>
</div>


<!-- SIGNATURE -->
<div class="section">
<div class="section-title">Declaration & Signatures</div>
<p class="note">
I hereby confirm that the above shipment has been handed over by the customer and
received by the logistics company in the stated condition and quantity for shipment
to the final destination.
</p>
<div class="row">
  <div class="col-6">
    <label>Customer Signature</label>
    <canvas id="sigCustomer" class="signature-box"></canvas>
    <button class="clear-btn hide-in-pdf" onclick="sigCustomer.clear()">Clear</button>
  </div>
  <div class="col-6">
    <label>Company Signature</label>
    <canvas id="sigCompany" class="signature-box"></canvas>
    <button class="clear-btn hide-in-pdf" onclick="sigCompany.clear()">Clear</button>
  </div>
</div>
</div>

<!-- SAVE PDF BUTTON -->
<div class="section hide-in-pdf">
  <button type="button" id="savePdfBtn" class="submit-btn">Save as PDF</button>
  <button type="button" id="sendEmailBtn" class="submit-btn" style="margin-top:10px;background:#2e7d32;">Send Email</button>
</div>

</div>

<script>
// SIGNATURE
const sigCustomer=new SignaturePad(document.getElementById("sigCustomer"));
const sigCompany=new SignaturePad(document.getElementById("sigCompany"));

// HELPER FUNCTIONS
async function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function getFileMimeType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const mimeTypes = {
    'pdf': 'application/pdf',
    'jpg': 'image/jpeg',
    'jpeg': 'image/jpeg',
    'png': 'image/png'
  };
  return mimeTypes[ext] || 'application/octet-stream';
}

function validateForm() {
  let isValid = true;
  const requiredFields = [
    'customerName', 'customerPhone', 'customerAddress',
    'consigneeName', 'consigneePhone', 'consigneeAddress',
    'transportMode', 'shipmentType', 'goodsDescription',
    'packagingType', 'packages', 'declaredWeight', 'cbm'
  ];
  
  // Hide all errors first
  document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
  
  requiredFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    const error = document.getElementById('error-' + fieldId);
    
    if (!field.value || field.value.trim() === '') {
      isValid = false;
      if (error) {
        error.style.display = 'block';
      }
      field.style.borderColor = '#c62828';
    } else {
      field.style.borderColor = '';
    }
  });
  
  if (!isValid) {
    alert('Please fill in all required fields marked with *');
  }
  
  return isValid;
}

// HIGHLIGHT FILLED
document.querySelectorAll("input,select,textarea").forEach(el=>{
  el.addEventListener("change",()=>{
    if(el.value || el.files?.length) el.classList.add("filled");
    else el.classList.remove("filled");
  });
  
  // Clear error on input
  el.addEventListener("input", () => {
    const error = document.getElementById('error-' + el.id);
    if (error && el.value) {
      error.style.display = 'none';
      el.style.borderColor = '';
    }
  });
});

// SAVE PDF
document.getElementById('savePdfBtn').addEventListener('click', function() {
    if (!validateForm()) return;
    
    // Hide elements before PDF generation
    document.querySelectorAll('.hide-in-pdf').forEach(el => {
      el.style.display = 'none';
    });
    
    const element = document.querySelector('.form-container');
    const opt = {
      margin:10,
      filename:'Cargo_Form.pdf',
      image:{ type:'jpeg', quality:0.98 },
      html2canvas:{ scale:2, scrollY:0 },
      jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' },
      pagebreak:{ mode:['avoid-all','css'] }
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
      // Show elements again after PDF is generated
      document.querySelectorAll('.hide-in-pdf').forEach(el => {
        el.style.display = '';
      });
    });
});

// SEND EMAIL
document.getElementById('sendEmailBtn').addEventListener('click', async function() {
  if (!validateForm()) return;
  
  // Check signatures
  if (sigCustomer.isEmpty() || sigCompany.isEmpty()) {
    alert('Please provide both customer and company signatures');
    return;
  }
  
  // Collect form data
  const formData = {
    customerName: document.getElementById('customerName').value,
    customerPhone: document.getElementById('customerPhone').value,
    customerAddress: document.getElementById('customerAddress').value,
    customerEmail: document.getElementById('customerEmail').value,
    consigneeName: document.getElementById('consigneeName').value,
    consigneePhone: document.getElementById('consigneePhone').value,
    consigneeAddress: document.getElementById('consigneeAddress').value,
    consigneeEmail: document.getElementById('consigneeEmail').value,
    consigneeCompany: document.getElementById('consigneeCompany').value,
    transportMode: document.getElementById('transportMode').value,
    shipmentType: document.getElementById('shipmentType').value,
    goodsDescription: document.getElementById('goodsDescription').value,
    packagingType: document.getElementById('packagingType').value,
    packages: document.getElementById('packages').value,
    declaredWeight: document.getElementById('declaredWeight').value,
    cbm: document.getElementById('cbm').value,
    files: []
  };

  // Process file uploads
  const fileInputs = [
    'invoiceFile', 'packingListFile', 'cmrFile',
    'originFile', 'msdsFile', 'otherFile'
  ];

  for (let id of fileInputs) {
    const input = document.getElementById(id);
    if (input.files.length > 0) {
      const file = input.files[0];
      const base64 = await fileToBase64(file);
      formData.files.push({
        name: file.name,
        data: base64,
        mimeType: getFileMimeType(file.name)
      });
    }
  }

  try {
    this.disabled = true;
    this.textContent = 'Converting to PDF...';
    
    // Hide elements before PDF generation
    document.querySelectorAll('.hide-in-pdf').forEach(el => {
      el.style.display = 'none';
    });
    
    // Generate PDF
    const element = document.querySelector('.form-container');
    const opt = {
      margin: 10,
      filename: 'Cargo_Form.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollY: 0 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css'] }
    };
    
    const pdf = await html2pdf().set(opt).from(element).outputPdf('dataurlstring');
    
    // Show elements again
    document.querySelectorAll('.hide-in-pdf').forEach(el => {
      el.style.display = '';
    });
    
    this.textContent = 'Sending...';
    
    // Split large data if needed
    const formDataStr = JSON.stringify(formData);
    const dataSize = new Blob([formDataStr]).size;
    const pdfSize = new Blob([pdf]).size;
    
    console.log('Data sizes:', { formData: dataSize, pdf: pdfSize });
    
    const response = await fetch('https://script.google.com/macros/s/AKfycbwaTP8XvVnf4wVaY-HfRKyxn-z0piRvxf0waLfDGeuj6Vq7uSOj9AyNqZD7cHL5nFUl5Q/exec', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        data: formDataStr,
        pdfData: pdf,
        timestamp: new Date().getTime()
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      alert('Form submitted successfully! Email sent with PDF attachment.');
      
      // Clear all form fields
      document.querySelectorAll("input, select, textarea").forEach(el => {
        if(el.type === 'file') {
          el.value = '';
        } else if(el.type === 'checkbox' || el.type === 'radio') {
          el.checked = false;
        } else {
          el.value = '';
        }
        el.classList.remove('filled');
      });
      
      // Clear signatures
      sigCustomer.clear();
      sigCompany.clear();
      
      // Scroll to top
      window.scrollTo({top: 0, behavior: 'smooth'});
    } else {
      throw new Error(result.message || 'Unknown error');
    }
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error submitting form: ' + error.message);
  } finally {
    this.disabled = false;
    this.textContent = 'Send Email';
  }
});

// AUTO SAVE EVERY 2 MINUTES
setInterval(() => {
  const saveData = {};
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if(el.type!=='file' && el.id) {
      saveData[el.id] = el.value;
    }
  });
  
  // Save signatures only if not empty
  if (!sigCustomer.isEmpty()) {
    saveData.sigCustomer = sigCustomer.toDataURL();
  }
  if (!sigCompany.isEmpty()) {
    saveData.sigCompany = sigCompany.toDataURL();
  }
  
  try {
    localStorage.setItem('cargoFormData', JSON.stringify(saveData));
  } catch (e) {
    console.error('Could not save to localStorage:', e);
  }
}, 120000);

// LOAD DATA ON PAGE LOAD
window.addEventListener('load', () => {
  try {
    const savedData = localStorage.getItem('cargoFormData');
    if (savedData) {
      const data = JSON.parse(savedData);
      
      Object.keys(data).forEach(key => {
        if (key === 'sigCustomer' && data[key]) {
          const img = new Image();
          img.src = data[key];
          img.onload = () => sigCustomer.fromDataURL(img.src);
        } else if (key === 'sigCompany' && data[key]) {
          const img = new Image();
          img.src = data[key];
          img.onload = () => sigCompany.fromDataURL(img.src);
        } else {
          const el = document.getElementById(key);
          if (el && data[key]) {
            el.value = data[key];
            if (el.value) el.classList.add('filled');
          }
        }
      });
    }
  } catch (e) {
    console.error('Could not load from localStorage:', e);
  }
});
</script>

</body>
</html>
